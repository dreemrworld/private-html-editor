<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Online Viewer - Test, Preview & Edit HTML Code Live</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Free online HTML viewer and editor. Test, preview, and edit HTML code live in your browser. No downloads required. Perfect for web developers and designers.">
    <meta name="keywords" content="HTML viewer, HTML editor, online HTML, HTML preview, test HTML, web development, HTML code editor">
    <meta name="author" content="HTML Online Viewer">
    <meta name="robots" content="index, follow">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="HTML Online Viewer - Test & Preview HTML Code">
    <meta property="og:description" content="Free online HTML viewer and editor. Test your HTML code instantly in the browser.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:image" content="">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="HTML Online Viewer">
    <meta name="twitter:description" content="Free online HTML viewer and editor for web developers">

    <!-- Canonical URL -->
    <link rel="canonical" href="html.goat.africa">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸŒ%3C/text%3E%3C/svg%3E">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 170px;
            background: #f9fbfd;
            color: black;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border-right: 1px solid #d3d3d3;
        }

        .sidebar-header {
            padding: 10px;
            background: #f5f5f5;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 2px solid #d3d3d3;
            height: 50px;
            display: flex;
            align-items: center;
        }

        .sidebar-item {
            padding: 12px 15px;
            border-bottom: 2px solid #d3d3d3;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }

        .sidebar-item:first-child {
            border-top: 2px solid #d3d3d3;
        }

        .sidebar-item:hover {
            background: lightgrey;
        }

        .sidebar-item.active {
            background: #1865f2;
            color: white;
        }

         /* Icon styles */
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin: 0 2px;
            display: flex; /* For SVG alignment */
            align-items: center;
            justify-content: center;
            border-radius: 3px;
        }
        .icon-btn:hover {
            background-color: #e0e0e0;
        }
        .icon-btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             background-color: transparent;
        }
        .icon-svg {
            width: 16px;
            height: 16px;
            fill: #333; /* Default icon color */
        }
        .icon-btn:disabled .icon-svg {
             fill: #999;
        }


        .sidebar-footer {
            margin-top: auto;
            padding: 15px;
            font-size: 11px;
            color: #bdc3c7;
            text-align: center;
            border-top: 2px solid #d3d3d3;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Editor Area */
        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .code-section {
            width: 50%;
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #d3d3d3;
            position: relative; /* For overlay positioning */
        }

         /* Overlay for editor section */
        .editor-overlay {
            position: absolute;
            top: 50px; /* Height of section-header */
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .editor-overlay-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            text-align: center;
        }


        .preview-section {
            width: 50%;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative; /* For overlay positioning */
        }

        /* Overlay for preview section */
        .preview-overlay {
            position: absolute;
            top: 50px; /* Height of section-header */
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .preview-overlay-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            text-align: center;
        }

        .section-header {
            background: #f9fbfd;
            padding: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #1a252f;
            border-bottom: 2px solid #d3d3d3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
        }

        .section-actions {
            display: flex;
            gap: 2px; /* Reduced gap */
            align-items: center;
        }

        .section-btn {
            background: #e0e0e0;
            border: 1px solid #ccc;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
        }
        .section-btn:hover {
             background: #d0d0d0;
        }
        .section-btn:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .code-editor {
            flex: 1;
            border: none;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            resize: none;
            line-height: 1.4;
            background: #ffffff;
        }

        .preview-frame {
            flex: 1;
            border: none;
            background: white;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #d3d3d3;
        }

        .close {
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 1px;
            cursor: pointer;
            font-size: 12px;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }

        /* File Input Styles */
        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }

        .file-label:hover {
            background: #2980b9;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
                overflow: auto;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-around;
            }

            .sidebar-header {
                width: 100%;
                text-align: center;
                font-size: 16px;
                padding: 8px;
            }

            .sidebar-item {
                flex: 1 1 auto;
                min-width: 60px;
                justify-content: center;
                padding: 10px 5px;
                font-size: 12px;
                border: 1px solid #d3d3d3;
                margin: 2px;
                border-radius: 4px;
            }

            .sidebar-footer {
                width: 100%;
                padding: 10px;
                font-size: 10px;
            }

            .editor-container {
                flex-direction: column;
                height: 70vh;
            }

            .code-section,
            .preview-section {
                width: 100%;
                height: 50%;
                border-right: none;
                border-bottom: 1px solid #d3d3d3;
            }

            .code-editor {
                font-size: 14px;
            }

            .modal-content {
                width: 90%;
                margin: 5% auto;
                padding: 20px;
            }

            .modal-header {
                padding-bottom: 10px;
                margin-bottom: 15px;
            }
        }

        /* Syntax highlighting (basic) */
        .highlight {
            background: #fff3cd !important;
        }

        /* Selected element highlight in preview */
        .preview-selected {
             outline: 2px dashed #1865f2 !important;
             outline-offset: 2px;
        }

        /* Inspector Panel */
        #inspectorPanel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(249, 251, 253, 0.95);
            border: 1px solid #d3d3d3;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none; /* Hidden by default */
        }
        #inspectorPanel h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 13px;
        }
        #inspectorPanel p {
            margin: 3px 0;
        }
        #deleteBtn {
            margin-top: 8px;
            padding: 5px 10px;
            font-size: 11px;
        }

    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">Private HTML</div>

        <div class="sidebar-item" onclick="previewFullPage()">
            <span></span> <span>Full Screen</span>
        </div>

        <div class="sidebar-item" onclick="clearEditor()">
            <span></span> <span>Clear</span>
        </div>

        <div class="sidebar-item" onclick="importFile()">
            <span></span> <span>Import</span>
        </div>

        <div class="sidebar-item" onclick="exportFile()">
            <span></span> <span>Download</span>
        </div>

        <div class="sidebar-item" onclick="showPrivacySettings()">
            <span></span> <span>Privacy</span>
        </div>

    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Editor Container -->
        <div class="editor-container">
            <!-- Code Section -->
            <div class="code-section">
                 <div class="section-header">
                    <span>Paste HTML text here</span>
                     <div class="section-actions">
                         <button class="icon-btn" id="undoBtn" onclick="undo()" title="Undo (Ctrl+Z)" disabled>
                             <!-- Simple Undo Icon SVG -->
                             <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
                         </button>
                         <button class="icon-btn" id="redoBtn" onclick="redo()" title="Redo (Ctrl+Y)" disabled>
                             <!-- Simple Redo Icon SVG -->
                             <svg class="icon-svg" viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
                         </button>
                         <button class="icon-btn" onclick="formatCode()" title="Format Code">
                             <!-- Simple Format Icon SVG -->
                             <svg class="icon-svg" viewBox="0 0 24 24"><path d="M5 17v2h14v-2H5zm4.5-4.2h5l.9 2.2h2.1L12.7 4h-1.4L6.5 15h2.1l.9-2.2zM12 5.98L13.87 11h-3.74L12 5.98z"/></svg>
                         </button>
                         <!-- <button class="section-btn" onclick="highlightCode()" title="Highlight Code">Highlight</button> -->
                     </div>
                 </div>
                <div class="editor-overlay" id="editorOverlay">
                    <div class="editor-overlay-content">
                        <p>Editing is disabled while interacting with the preview.</p>
                        <button class="btn btn-secondary" onclick="exitPreviewEditMode()">Exit Edit Mode</button>
                    </div>
                </div>
                <textarea class="code-editor" id="htmlCode" placeholder="Enter your HTML code here..."><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample HTML Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background: linear-gradient(135deg, #1865f2 0%, #1865f2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        h1 {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        .btn {
            background: white;
            color: #1865f2;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .highlight-box {
            border: 2px dashed red;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Online HTML Viewer</h1>
        <p>Edit and preview your html with 100% privacy and with no ads.</p>
        <button class="btn" onclick="alert('Hello from HTML Viewer!')">Click Me!</button>
    </div>
</body>
</html></textarea>
            </div>

            <!-- Preview Section -->
            <div class="preview-section">
                <div class="section-header">
                    <span>Preview</span>
                     <div class="section-actions">
                         <button class="section-btn" id="editPreviewBtn" onclick="enterPreviewEditMode()" title="Enable Edit Mode in Preview">Edit Mode</button>
                         <button class="section-btn" id="refreshPreviewBtn" onclick="updatePreview()" title="Refresh Preview">Refresh</button>
                     </div>
                 </div>
                 <div class="preview-overlay" id="previewOverlay">
                    <div class="preview-overlay-content">
                        <p>Preview is updating. Please wait...</p>
                    </div>
                 </div>
                <iframe class="preview-frame" id="preview"></iframe>
                <div id="inspectorPanel">
                    <h4>Selected Element:</h4>
                    <p id="selectedTag">None</p>
                    <p id="selectedId">ID: -</p>
                    <p id="selectedClass">Class: -</p>
                    <button class="btn btn-danger" id="deleteBtn" onclick="deleteSelectedElement()" disabled>Delete Element</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" class="file-input" accept=".html,.htm,.txt" onchange="handleFileImport(event)">
    <!-- Privacy Settings Modal -->
    <div id="privacyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Privacy Settings</h3>
                <span class="close" onclick="closeModal('privacyModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>Your Privacy is Important</strong></p>
                <br>
                <p>âœ… All code processing happens in your browser</p>
                <p>âœ… No data is sent to our servers</p>
                <p>âœ… No tracking or analytics on your code</p>
                <p>âœ… Your HTML code remains completely private</p>
                <br>
                <p><strong>Data Usage:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>No personal information is collected</li>
                </ul>
                <br>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="closeModal('privacyModal')">Got it</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "HTML Online Viewer",
        "description": "Free online HTML viewer and editor. Test, preview, and edit HTML code live in your browser.",
        "url": "",
        "applicationCategory": "DeveloperApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "HTML Online Viewer"
        }
    }
    </script>

    <!-- JavaScript -->
    <script>
        let isPreviewEditMode = false;
        let selectedElementPath = null;

        // --- Undo/Redo History ---
        const history = {
            states: [''], // Initialize with empty state or initial code?
            currentIndex: 0,
            maxSize: 50 // Limit history size
        };

        function updateHistory() {
            const currentCode = document.getElementById('htmlCode').value;
            // If the current code is the same as the last history state, don't add it
            if (history.states[history.currentIndex] === currentCode) {
                 // Update button states based on current index
                 updateUndoRedoButtons();
                 return;
            }

            // If we are in the middle of history, truncate forward history
            if (history.currentIndex < history.states.length - 1) {
                history.states = history.states.slice(0, history.currentIndex + 1);
            }

            // Add new state
            history.states.push(currentCode);
            history.currentIndex++;

            // Limit history size
            if (history.states.length > history.maxSize) {
                history.states.shift(); // Remove oldest state
                history.currentIndex--; // Adjust index
            }

            // Update button states
            updateUndoRedoButtons();
        }

        function undo() {
            if (history.currentIndex > 0) {
                history.currentIndex--;
                document.getElementById('htmlCode').value = history.states[history.currentIndex];
                updateUndoRedoButtons();
                // Trigger preview update after undo
                debounceUpdatePreview(); // Use debounced version
                exitPreviewEditMode(); // Exit edit mode as content changed
            }
        }

        function redo() {
            if (history.currentIndex < history.states.length - 1) {
                history.currentIndex++;
                document.getElementById('htmlCode').value = history.states[history.currentIndex];
                updateUndoRedoButtons();
                 // Trigger preview update after redo
                debounceUpdatePreview(); // Use debounced version
                exitPreviewEditMode(); // Exit edit mode as content changed
            }
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (undoBtn) undoBtn.disabled = (history.currentIndex <= 0);
            if (redoBtn) redoBtn.disabled = (history.currentIndex >= history.states.length - 1);
        }

        // Auto-run code on load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize history with the initial content
            updateHistory();
            updatePreview();

            // Auto-update preview as user types (with debounce)
            // Use a more frequent debounce for history updates
            document.getElementById('htmlCode').addEventListener('input', function() {
                 // Update history on every input change
                 updateHistory();
                 // Debounced preview update
                 debounceUpdatePreview();
            });
        });

        // Debounce function for preview updates
        let previewUpdateTimeout;
        function debounceUpdatePreview() {
             clearTimeout(previewUpdateTimeout);
             previewUpdateTimeout = setTimeout(updatePreview, 500); // 500ms delay
        }


        // --- Preview Interaction Logic ---

        function injectInteractionScript(iframeDoc) {
            if (!iframeDoc) return;

            const existingScript = iframeDoc.getElementById('preview-interaction-script');
            if (existingScript) existingScript.remove();
            const existingStyle = iframeDoc.getElementById('preview-interaction-style');
            if (existingStyle) existingStyle.remove();

            const highlightStyle = iframeDoc.createElement('style');
            highlightStyle.id = 'preview-interaction-style';
            highlightStyle.textContent = `
                .preview-selected-highlight {
                    outline: 2px dashed #e74c3c !important;
                    outline-offset: 2px;
                    background-color: rgba(231, 76, 60, 0.1) !important;
                }
            `;
            iframeDoc.head.appendChild(highlightStyle);

            const script = iframeDoc.createElement('script');
            script.id = 'preview-interaction-script';
            script.textContent = `
                (function() {
                    let currentlyHighlighted = null;

                    function highlightElement(el) {
                        if (currentlyHighlighted) {
                            currentlyHighlighted.classList.remove('preview-selected-highlight');
                        }
                        if (el && el.nodeType === Node.ELEMENT_NODE && el.tagName !== 'HTML' && el.tagName !== 'BODY') {
                            el.classList.add('preview-selected-highlight');
                            currentlyHighlighted = el;

                            const tag = el.tagName.toLowerCase();
                            const id = el.id || '-';
                            const className = el.className || '-';
                            window.parent.postMessage({
                                type: 'elementSelected',
                                tag: tag,
                                id: id,
                                class: className,
                            }, '*');

                        } else {
                             window.parent.postMessage({ type: 'elementSelected', tag: 'None', id: '-', class: '-' }, '*');
                             currentlyHighlighted = null;
                        }
                    }

                    document.addEventListener('click', function(e) {
                        e.preventDefault();
                        highlightElement(e.target);
                    }, true);

                     window.addEventListener('message', function(event) {
                         if (event.data.type === 'deleteSelectedElement' && currentlyHighlighted) {
                             const elementToDelete = currentlyHighlighted;
                             highlightElement(null);
                             elementToDelete.remove();
                             window.parent.postMessage({ type: 'elementDeleted' }, '*');
                         }
                         if (event.data.type === 'exitEditMode') {
                              if (currentlyHighlighted) {
                                  currentlyHighlighted.classList.remove('preview-selected-highlight');
                                  currentlyHighlighted = null;
                              }
                              window.parent.postMessage({ type: 'editModeExited' }, '*');
                         }
                     });
                })();
            `;
            iframeDoc.body.appendChild(script);
        }

        window.addEventListener('message', function(event) {
             if (event.data.type === 'elementSelected') {
                 document.getElementById('selectedTag').textContent = `Tag: <${event.data.tag}>`;
                 document.getElementById('selectedId').textContent = `ID: ${event.data.id}`;
                 document.getElementById('selectedClass').textContent = `Class: ${event.data.class}`;
                 document.getElementById('deleteBtn').disabled = (event.data.tag === 'None');
                 document.getElementById('inspectorPanel').style.display = 'block';
             }
             if (event.data.type === 'elementDeleted') {
                 syncEditorFromPreview();
             }
             if (event.data.type === 'editModeExited') {
                 exitPreviewEditMode();
             }
        });

        // --- Preview Update and Sync ---

        function updatePreview() {
             const overlay = document.getElementById('previewOverlay');
             if (overlay) overlay.style.display = 'flex';

             setTimeout(()=> {
                const code = document.getElementById('htmlCode').value;
                const preview = document.getElementById('preview');
                const blob = new Blob([code], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                preview.onload = function() {
                    if (isPreviewEditMode) {
                        injectInteractionScript(preview.contentDocument);
                    }
                    if (overlay) overlay.style.display = 'none';
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                };
                preview.src = url;
             }, 100);
        }

        function syncEditorFromPreview() {
            const preview = document.getElementById('preview');
            if (!preview.contentDocument) {
                console.warn("Cannot sync: Preview document not accessible.");
                return;
            }
            try {
                let doctypeString = "";
                const doctype = preview.contentDocument.doctype;
                if (doctype) {
                     doctypeString = "<!DOCTYPE "
                                    + doctype.name
                                    + (doctype.publicId ? ' PUBLIC "' + doctype.publicId + '"' : '')
                                    + (!doctype.publicId && doctype.systemId ? ' SYSTEM' : '')
                                    + (doctype.systemId ? ' "' + doctype.systemId + '"' : '')
                                    + '>';
                }

                const htmlString = doctypeString + "\n" + preview.contentDocument.documentElement.outerHTML;

                const editor = document.getElementById('htmlCode');
                const oldScrollTop = editor.scrollTop;
                editor.value = htmlString;
                editor.scrollTop = oldScrollTop;

                // Update history and buttons after sync
                updateHistory();
                updateUndoRedoButtons();

                console.log("Editor synced from preview changes.");

            } catch (e) {
                console.error("Error syncing editor from preview:", e);
                alert("Could not sync changes back to editor. Please refresh the preview.");
            }
        }


        // --- Edit Mode Controls ---

        function enterPreviewEditMode() {
            if (isPreviewEditMode) return;
            isPreviewEditMode = true;
            const btn = document.getElementById('editPreviewBtn');
            if (btn) {
                btn.textContent = 'Exit Edit';
                btn.title = 'Exit Edit Mode in Preview';
                btn.classList.add('active');
            }
            const editorOverlay = document.getElementById('editorOverlay');
            if (editorOverlay) editorOverlay.style.display = 'flex';

            const preview = document.getElementById('preview');
            if (preview.contentDocument && preview.contentDocument.readyState === 'complete') {
                 injectInteractionScript(preview.contentDocument);
            }
        }

        function exitPreviewEditMode() {
            if (!isPreviewEditMode) return;
            isPreviewEditMode = false;
            const btn = document.getElementById('editPreviewBtn');
            if (btn) {
                btn.textContent = 'Edit Mode';
                btn.title = 'Enable Edit Mode in Preview';
                 btn.classList.remove('active');
            }
            const editorOverlay = document.getElementById('editorOverlay');
            if (editorOverlay) editorOverlay.style.display = 'none';

             const preview = document.getElementById('preview');
             if (preview.contentWindow) {
                 preview.contentWindow.postMessage({ type: 'exitEditMode' }, '*');
             }
             document.getElementById('selectedTag').textContent = 'Tag: None';
             document.getElementById('selectedId').textContent = 'ID: -';
             document.getElementById('selectedClass').textContent = 'Class: -';
             document.getElementById('deleteBtn').disabled = true;
             document.getElementById('inspectorPanel').style.display = 'none';

        }

        // --- Element Actions ---

        function deleteSelectedElement() {
            if (!isPreviewEditMode) {
                alert("Please enter Edit Mode first.");
                return;
            }
            const preview = document.getElementById('preview');
            if (preview.contentWindow) {
                preview.contentWindow.postMessage({ type: 'deleteSelectedElement' }, '*');
            }
        }

        // --- Existing Functions (adjusted) ---

        function previewFullPage() {
            const code = document.getElementById('htmlCode').value;
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }

        function highlightCode() {
            const editor = document.getElementById('htmlCode');
            editor.style.background = '#e8f4ff';
            setTimeout(() => {
                editor.style.background = 'white';
            }, 1000);
            alert('Visual feedback shown. Full syntax highlighting requires a library.');
        }

        // Enhanced HTML beautification function
        function formatCode() {
            const editor = document.getElementById('htmlCode');
            let code = editor.value;

            if (!code.trim()) {
                alert("Nothing to format!");
                return;
            }

            try {
                // Parse HTML using DOMParser for better compatibility
                const parser = new DOMParser();
                const doc = parser.parseFromString(code, 'text/html');
                
                // Check for parsing errors
                const parserError = doc.querySelector('parsererror');
                if (parserError) {
                    console.warn("HTML parsing errors detected:", parserError.textContent);
                    // Continue with formatting but warn user
                    if (!confirm("Potential HTML errors detected during parsing. Continue with formatting?")) {
                        return;
                    }
                }

                // Get DOCTYPE from original code
                let doctypeString = "";
                const doctypeMatch = code.trim().match(/^<!DOCTYPE[^>]*>/i);
                if (doctypeMatch) {
                    doctypeString = doctypeMatch[0] + '\n';
                }

                // Beautify the HTML document
                const beautifiedHTML = beautifyHTML(doc.documentElement);
                
                // Combine DOCTYPE and beautified HTML
                const formattedCode = doctypeString + beautifiedHTML;

                // Update the editor
                const oldScrollTop = editor.scrollTop;
                editor.value = formattedCode;
                editor.scrollTop = oldScrollTop;

                // Update history and preview
                updateHistory();
                updateUndoRedoButtons();
                debounceUpdatePreview();

                console.log("HTML beautified successfully.");

            } catch (e) {
                console.error("Beautification error:", e);
                alert("Could not beautify code. Error: " + e.message);
            }
        }

        // HTML beautification helper function
        function beautifyHTML(element, indentLevel = 0) {
            const indent = '  '.repeat(indentLevel);
            const nextIndent = '  '.repeat(indentLevel + 1);
            let result = '';

            if (element.nodeType === Node.ELEMENT_NODE) {
                const tagName = element.tagName.toLowerCase();
                
                // Handle special cases
                if (tagName === 'script' || tagName === 'style') {
                    result += `${indent}<${tagName}`;
                    
                    // Add attributes
                    for (const attr of element.attributes) {
                        result += ` ${attr.name}="${attr.value}"`;
                    }
                    
                    result += '>';
                    
                    // Format content for script/style tags
                    const content = element.textContent.trim();
                    if (content) {
                        if (tagName === 'style') {
                            result += `\n${beautifyCSS(content, indentLevel + 1)}\n${indent}`;
                        } else if (tagName === 'script' && !element.getAttribute('src')) {
                            result += `\n${beautifyJS(content, indentLevel + 1)}\n${indent}`;
                        } else {
                            result += content;
                        }
                    }
                    
                    result += `</${tagName}>\n`;
                    return result;
                }

                // Start tag with attributes
                result += `${indent}<${tagName}`;
                for (const attr of element.attributes) {
                    result += ` ${attr.name}="${attr.value}"`;
                }
                result += '>';

                // Handle children
                const children = Array.from(element.childNodes);
                const hasElementChildren = children.some(child => child.nodeType === Node.ELEMENT_NODE);
                const hasTextContent = children.some(child => 
                    child.nodeType === Node.TEXT_NODE && child.textContent.trim()
                );

                if (hasElementChildren || hasTextContent) {
                    result += '\n';

                    // Process children
                    for (const child of children) {
                        if (child.nodeType === Node.ELEMENT_NODE) {
                            result += beautifyHTML(child, indentLevel + 1);
                        } else if (child.nodeType === Node.TEXT_NODE) {
                            const text = child.textContent.trim();
                            if (text) {
                                result += `${nextIndent}${text}\n`;
                            }
                        }
                    }

                    result += `${indent}`;
                } else if (element.textContent.trim()) {
                    result += element.textContent.trim();
                }

                result += `</${tagName}>\n`;
            }

            return result;
        }

        // CSS beautification helper
        function beautifyCSS(css, indentLevel = 0) {
            const indent = '  '.repeat(indentLevel);
            let result = '';
            let inRule = false;
            
            // Simple CSS formatting - add indentation
            const lines = css.split(';').join(';\n').split('{').join('{\n').split('}').join('\n}\n').split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                if (line.endsWith('{')) {
                    result += `${indent}${line}\n`;
                    inRule = true;
                } else if (line.endsWith('}')) {
                    inRule = false;
                    result += `${indent}${line}\n`;
                } else if (inRule) {
                    result += `${indent}  ${line}\n`;
                } else {
                    result += `${indent}${line}\n`;
                }
            }
            
            return result.trim();
        }

        // JavaScript beautification helper
        function beautifyJS(js, indentLevel = 0) {
            const indent = '  '.repeat(indentLevel);
            let result = '';
            
            // Simple JS formatting - basic indentation
            const lines = js.split('\n');
            let currentIndent = 0;
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                // Adjust indentation based on braces
                if (line.includes('}')) currentIndent--;
                if (line.includes('{') && !line.includes('}')) currentIndent++;
                
                const lineIndent = '  '.repeat(indentLevel + Math.max(0, currentIndent - (line.includes('}') ? 1 : 0)));
                result += `${lineIndent}${line}\n`;
                
                if (line.includes('{') && line.includes('}')) currentIndent--;
            }
            
            return result.trim();
        }


        function clearEditor() {
            if (confirm('Are you sure you want to clear all code?')) {
                document.getElementById('htmlCode').value = '';
                updateHistory(); // Update history after clear
                updatePreview();
                exitPreviewEditMode();
            }
        }

        // Handle file import - MODIFIED to beautify on import
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                // Basic file size check (optional, but good practice)
                const maxFileSize = 5 * 1024 * 1024; // 5 MB example limit
                if (file.size > maxFileSize) {
                    if (!confirm(`This file is ${(file.size / (1024 * 1024)).toFixed(2)} MB. Large files might cause performance issues. Continue loading?`)) {
                         // Clear the file input to allow selecting the same file again if cancelled
                         document.getElementById('fileInput').value = '';
                         return;
                    }
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const rawCode = e.target.result;

                    // Update editor with raw code first to provide immediate feedback
                    const editor = document.getElementById('htmlCode');
                    editor.value = rawCode;
                    // Update history for the raw import
                    updateHistory();
                    // Exit edit mode if it was active
                    exitPreviewEditMode();

                    // Attempt to beautify the imported code using the new beautification functions
                    console.log("Attempting to beautify imported code...");
                    try {
                        // Temporarily disable the input listener to avoid triggering history updates during beautification
                        const editorInputListener = editor.oninput; // Store the listener (though we access it differently)
                        editor.oninput = null; // Remove the listener

                        // Parse HTML using DOMParser
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(rawCode, 'text/html');
                        
                        // Check for parsing errors
                        const parserError = doc.querySelector('parsererror');
                        if (parserError) {
                            console.warn("HTML parsing errors detected during import:", parserError.textContent);
                        }

                        // Get DOCTYPE from original code
                        let doctypeString = "";
                        const doctypeMatch = rawCode.trim().match(/^<!DOCTYPE[^>]*>/i);
                        if (doctypeMatch) {
                            doctypeString = doctypeMatch[0] + '\n';
                        }

                        // Beautify the HTML document using the new beautification function
                        const beautifiedHTML = beautifyHTML(doc.documentElement);
                        
                        // Combine DOCTYPE and beautified HTML
                        const beautifiedCode = doctypeString + beautifiedHTML;

                        // Update the editor with the beautified code
                        const oldScrollTop = editor.scrollTop;
                        editor.value = beautifiedCode;
                        editor.scrollTop = oldScrollTop;

                        console.log("Imported code beautified successfully.");

                        // Update history with the beautified state
                        updateHistory();
                    } catch (beautifyError) {
                        console.error("Error beautifying imported code:", beautifyError);
                        alert("File loaded, but beautification failed. Displaying raw content. Error: " + beautifyError.message);
                        // Editor already contains rawCode, so it will be displayed as-is
                    } finally {
                        // Re-attach the input listener
                        // Use debounce for the re-attached listener
                         editor.oninput = function() {
                             updateHistory(); // Update history on every input change
                             debounceUpdatePreview(); // Debounced preview update
                         };
                    }

                    // Update preview (it will use whatever code is currently in the editor - raw or beautified)
                    updatePreview();
                };
                reader.onerror = function(e) {
                     console.error("File read error:", e);
                     alert("Error reading file.");
                     document.getElementById('fileInput').value = ''; // Clear input on error
                };
                reader.readAsText(file);
            }
            // Clear the value to ensure 'change' event fires again if the same file is re-selected
            event.target.value = '';
        }


        function importFile() {
            document.getElementById('fileInput').click();
        }

        function exportFile() {
            const code = document.getElementById('htmlCode').value;
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-html-file.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showPrivacySettings() {
            document.getElementById('privacyModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Optional: Add keyboard shortcuts for undo/redo (Ctrl+Z, Ctrl+Y)
        document.addEventListener('keydown', function(e) {
             if (e.ctrlKey || e.metaKey) { // Ctrl (Windows/Linux) or Cmd (Mac)
                 if (e.key === 'z' && !e.shiftKey) {
                     e.preventDefault();
                     undo();
                 } else if ((e.key === 'z' && e.shiftKey) || e.key === 'y') {
                     e.preventDefault();
                     redo();
                 }
             }
        });
    </script>
</body>
</html>
